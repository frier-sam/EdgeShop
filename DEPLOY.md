# Deployment Guide

## Prerequisites

- [Cloudflare account](https://dash.cloudflare.com/sign-up) (free tier is sufficient)
- Node.js 18+
- wrangler CLI: `npm install -g wrangler`
- Logged in: `wrangler login`

---

## Option A — One-command setup (recommended)

```bash
bash scripts/setup.sh
```

The script handles everything:
- Creates D1 database and applies all 11 migrations
- Creates R2 bucket (you enable public access in dashboard — one click)
- Auto-generates a JWT secret
- Optionally sets Razorpay webhook secret (skippable — Razorpay API keys go in Admin)
- Deploys the Worker and frontend to Cloudflare
- Prints your store URL, admin URL, and next steps

---

## Option B — Manual step-by-step

### 1. Create D1 Database

```bash
npx wrangler d1 create edgeshop-db
```

Copy the `database_id` from the output and update `worker/wrangler.toml`:

```toml
[[d1_databases]]
binding = "DB"
database_name = "edgeshop-db"
database_id = "YOUR_DATABASE_ID_HERE"
migrations_dir = "migrations"
```

### 2. Apply All Migrations

```bash
cd worker
npx wrangler d1 migrations apply edgeshop-db --remote --yes
```

This applies all 11 migrations in order and tracks which ones have run in a `d1_migrations` table. Safe to re-run — only pending migrations are applied. Run the same command whenever you pull a new version of EdgeShop that adds migrations.

### 3. Create R2 Bucket

```bash
npx wrangler r2 bucket create edgeshop-images
```

Enable public access in the Cloudflare dashboard:
**R2 → edgeshop-images → Settings → Public Access → Enable**

Copy the public URL (e.g. `https://pub-xxxx.r2.dev`) and update `worker/wrangler.toml`:

```toml
[vars]
R2_PUBLIC_URL = "https://pub-xxxx.r2.dev"
```

### 4. Set Secrets

```bash
cd worker

# Required — auto-generated by setup.sh, or generate manually:
echo "$(openssl rand -hex 32)" | npx wrangler secret put JWT_SECRET

# Optional — only needed if using Razorpay webhooks for payment confirmation.
# Razorpay API keys (key_id + key_secret) go in Admin → Integrations → Payment.
npx wrangler secret put RAZORPAY_WEBHOOK_SECRET
```

### 5. Deploy Worker

Update `FRONTEND_URL` in `worker/wrangler.toml` to your Pages URL first, then:

```bash
cd worker
npm run deploy
```

`npm run deploy` applies any pending migrations then deploys the Worker. Note the worker URL from the output.

### 6. Deploy Frontend

```bash
cd frontend
npm install
npm run build
../worker/node_modules/.bin/wrangler pages deploy dist --project-name edgeshop
```

### 7. Protect Admin with Cloudflare Access

In [Cloudflare Zero Trust](https://one.dash.cloudflare.com):
1. **Access → Applications → Add an application → Self-hosted**
2. Application domain: `your-pages-url.pages.dev/admin/*`
3. Add a policy (e.g. allow by email)

No auth code needed in the app — Cloudflare Access intercepts `/admin/*` at the edge before the page loads.

---

## Integrations

All third-party integrations are configured via **Admin → Integrations** after deployment — nothing to set up at deploy time.

| Integration | Where to configure |
|---|---|
| Razorpay (UPI, cards, netbanking) | Admin → Integrations → Payment |
| Resend / SendGrid / Brevo (email) | Admin → Integrations → Email |
| ShipRocket (shipping & tracking) | Admin → Integrations → Shipping |

---

## CI/CD — Auto-deploy on push to main

Add these two secrets to your GitHub repository (**Settings → Secrets and variables → Actions → New repository secret**):

| Secret | Where to find it |
|---|---|
| `CLOUDFLARE_API_TOKEN` | [Cloudflare dashboard → My Profile → API Tokens](https://dash.cloudflare.com/profile/api-tokens) → Create Token → Edit Cloudflare Workers template |
| `CLOUDFLARE_ACCOUNT_ID` | Cloudflare dashboard → right sidebar on any Workers or Pages page |

Once set, every push to `main` automatically:
1. Applies any pending D1 migrations
2. Deploys the Worker
3. Builds and deploys the frontend to Pages

The workflow file is at `.github/workflows/deploy.yml`.

---

## Local Development

```bash
# Terminal 1 — Worker API (http://localhost:8787)
cd worker && npx wrangler dev

# Terminal 2 — Frontend (http://localhost:5173, proxies /api → :8787)
cd frontend && npm run dev
```

First-time local D1 setup:
```bash
cd worker
npx wrangler d1 migrations apply edgeshop-db --local --yes
```

---

## Applying Updates

When you pull a new version of EdgeShop:

```bash
git pull

# Deploy worker (applies any new migrations automatically)
cd worker && npm run deploy

# Deploy frontend
cd frontend && npm run build && ../worker/node_modules/.bin/wrangler pages deploy dist --project-name edgeshop
```

`npm run deploy` in the worker always runs pending migrations first — you never need to run migration commands manually when updating.
